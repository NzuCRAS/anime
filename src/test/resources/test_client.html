<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anime - 测试客户端 (full API test)</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
        input, button, textarea, select { font-size: 14px; margin: 4px 0; }
        .box { border: 1px solid #ddd; padding: 12px; margin: 12px 0; border-radius: 6px; }
        .log { white-space: pre-wrap; background: #f7f7f7; padding: 8px; border-radius: 4px; max-height: 360px; overflow:auto; }
        label { display:block; margin-top:8px; }
        .placeholder { color:#999; font-size:13px; }
        .user-info { display:flex; gap:12px; align-items:center; }
        .user-info img { width:64px; height:64px; object-fit:cover; border-radius:50%; border:1px solid #ddd; }
        .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        .col { flex:1 1 300px; min-width:220px; }
        table { border-collapse: collapse; width:100%; }
        th, td { border: 1px solid #eee; padding:6px; text-align:left; font-size:13px; }
    </style>
</head>
<body>
<h2>测试客户端：全接口（分业务区域）</h2>

<!-- User info -->
<div class="box">
    <h3>当前用户</h3>
    <div class="user-info">
        <img id="userAvatarSmall" src="" alt="avatar" style="display:none;">
        <div>
            <div id="userName" style="font-weight:600">未登录</div>
            <div id="userSignature" class="placeholder"></div>
            <div id="userId" class="placeholder"></div>
        </div>
    </div>
</div>

<!-- Auth (login/register/refresh/logout/ping) -->
<div class="box">
    <h3>Auth 测试（登录/注册/刷新/登出/ping）</h3>
    <div class="row">
        <div class="col">
            <label>用户名或邮箱：<input id="username" value="test_name"></label>
            <label>密码：<input id="password" type="password" value="test_password"></label>
            <label>邮箱(for register)：<input id="regEmail" value="test_email"></label>
            <div class="row">
                <button id="btnLogin">登录</button>
                <button id="btnRegister">注册</button>
                <button id="btnRefresh">刷新 token</button>
                <button id="btnLogout">登出</button>
                <button id="btnPing">Ping</button>
            </div>
        </div>
    </div>
</div>

<!-- User avatar presign/upload/bind (already present) -->
<div class="box">
    <h3>User Avatar 流程（presign -> PUT -> complete -> bind）</h3>
    <div class="row">
        <input type="file" id="avatarFileInput" accept="image/*">
        <input id="avatarOrigName" placeholder="avatar.jpg">
        <button id="btnUserPresignUpload">Presign & Upload (/api/user/presign)</button>
        <button id="btnBindAvatar" disabled>绑定头像 (/api/user/userAvatar)</button>
    </div>
    <div style="margin-top:8px;">
        <span>最近 attachmentId: <span id="avatarAttachmentId">-</span></span>
        <img id="avatarPreview" class="avatar-preview" style="display:none;max-width:120px;margin-left:12px;">
    </div>
</div>

<!-- Attachment tests -->
<div class="box">
    <h3>Attachment 测试</h3>
    <div class="row">
        <input id="attachmentsIdForGet" placeholder="attachmentId for presigned-get">
        <button id="btnPresignedGet">获取 presigned-get (/api/attachments/{id}/presigned-get)</button>
        <button id="btnAttachmentsPresign">通用 presign (/api/attachments/presign) - 使用 fileInput 上方选中文件</button>
    </div>
</div>

<!-- Diary tests -->
<div class="box">
    <h3>Diary 测试</h3>
    <div class="row">
        <button id="btnGetMyDiaries">获取我的日记摘要 (/api/diary/getMyDiary)</button>
        <input id="dateForDiaries" placeholder="yyyy-mm-dd">
        <button id="btnGetDiariesByDate">按日期获取 (/api/diary/date/{date})</button>
    </div>
    <div style="margin-top:8px;">
        <input id="diaryIdToDelete" placeholder="diaryId to delete">
        <button id="btnDeleteDiary">删除日记 (/api/diary/delete/{id})</button>
    </div>
</div>

<!-- Collection Folder Level1 tests -->
<div class="box">
    <h3>收藏夹 Level1 测试</h3>
    <div class="row">
        <input id="lvl1Name" placeholder="folder name">
        <input id="lvl1AttachmentId" placeholder="cover attachmentId">
        <button id="btnCreateLevel1">创建一级收藏夹（createNewFolder）</button>
        <button id="btnGetUserFolders">获取我的一级收藏夹 (/getUserFolders)</button>
    </div>
    <div style="margin-top:8px;">
        <input id="lvl1Id" placeholder="level1 id">
        <input id="lvl1NewName" placeholder="new name">
        <button id="btnUpdateLevel1Name">更新名称</button>
        <input id="lvl1UpdateCoverAttachment" placeholder="new cover attachmentId">
        <button id="btnUpdateLevel1Cover">更新封面</button>
        <button id="btnDeleteLevel1">删除一级收藏夹</button>
    </div>
</div>

<!-- Collection Folder Level2 tests -->
<div class="box">
    <h3>收藏夹 Level2 测试</h3>
    <div class="row">
        <input id="lvl2Name" placeholder="level2 name">
        <input id="lvl2ParentId" placeholder="father level1 id">
        <button id="btnCreateLevel2">创建二级收藏夹</button>
        <input id="lvl2QueryParent" placeholder="parent id for getFoldersByParent">
        <button id="btnGetLevel2ByParent">获取父级下的二级收藏夹</button>
    </div>
    <div style="margin-top:8px;">
        <input id="lvl2Id" placeholder="level2 id">
        <input id="lvl2NewName" placeholder="new name">
        <button id="btnUpdateLevel2Name">更新二级名称</button>
        <button id="btnDeleteLevel2">删除二级收藏夹</button>
    </div>
</div>

<!-- Collected Item tests -->
<div class="box">
    <h3>Collected Item 测试</h3>
    <div class="row">
        <input id="itemAttachmentId" placeholder="attachment id for item">
        <input id="itemName" placeholder="item name">
        <input id="itemDescription" placeholder="description">
        <input id="itemFatherLevel2Id" placeholder="father_level2_id">
        <button id="btnCreateItemCustom">创建自定义收藏项</button>
        <button id="btnCreateItemDefault">创建默认收藏项</button>
    </div>
    <div style="margin-top:8px;">
        <input id="itemId" placeholder="item id">
        <input id="itemNewName" placeholder="new name">
        <input id="itemNewDesc" placeholder="new desc">
        <input id="itemNewCoverAttachment" placeholder="new cover attachment id">
        <div class="row">
            <button id="btnUpdateItemName">更新名称</button>
            <button id="btnUpdateItemDesc">更新描述</button>
            <button id="btnUpdateItemCover">更新封面</button>
            <button id="btnDeleteItem">删除收藏项</button>
        </div>
    </div>
</div>

<!-- Log -->
<div class="box">
    <h3>日志 / 响应</h3>
    <div id="log" class="log"></div>
</div>

<script>
    const BASE = 'https://localhost:8443';
    let currentAccessToken = null;
    let lastAvatarAttachmentId = null;

    function log(msg) {
        const el = document.getElementById('log');
        const now = new Date().toISOString();
        el.textContent = `${now}  ${msg}\n\n` + el.textContent;
    }

    function authHeaders() {
        const h = {};
        if (currentAccessToken) h['Authorization'] = 'Bearer ' + currentAccessToken;
        return h;
    }

    function setUserInfoFromPayload(payload) {
        if (!payload) return;
        document.getElementById('userName').textContent = payload.username || ('user-' + (payload.id || ''));
        document.getElementById('userSignature').textContent = payload.personalSignature || '';
        document.getElementById('userId').textContent = payload.id ? `userId: ${payload.id}` : '';
        const avatar = payload.userAvatarUrl;
        const avatarEl = document.getElementById('userAvatarSmall');
        if (avatar) {
            avatarEl.src = avatar;
            avatarEl.style.display = 'block';
        } else {
            avatarEl.style.display = 'none';
        }
    }

    // ------------------- Auth handlers -------------------
    document.getElementById('btnLogin').addEventListener('click', async () => {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        try {
            const res = await fetch(`${BASE}/api/user/login`, {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ usernameOrEmail: username, password })
            });
            const text = await res.text();
            log(`[login] status=${res.status} body=${text}`);
            const headerToken = res.headers.get('New-Access-Token');
            if (headerToken) {
                currentAccessToken = headerToken;
                log('[login] saved New-Access-Token from header');
            }
            try {
                const json = JSON.parse(text);
                const data = json.data || json;
                if (data && (data.username || data.userAvatarUrl || data.personalSignature)) {
                    setUserInfoFromPayload(data);
                }
            } catch(e){}
        } catch (e) { log('[login] error: ' + e.message); }
    });

    document.getElementById('btnRegister').addEventListener('click', async () => {
        const username = document.getElementById('username').value;
        const pwd = document.getElementById('password').value;
        const email = document.getElementById('regEmail').value;
        try {
            const res = await fetch(`${BASE}/api/user/register`, {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password: pwd, confirmPassword: pwd, email })
            });
            const json = await res.json().catch(()=>null);
            log(`[register] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[register] error: '+e.message); }
    });

    document.getElementById('btnRefresh').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/auth/refresh`, {
                method: 'POST',
                credentials: 'include',
                headers: {'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest'}
            });
            const json = await res.json().catch(()=>null);
            log(`[refresh] status=${res.status} body=${JSON.stringify(json)}`);
            const headerToken = res.headers.get('New-Access-Token');
            if (headerToken) {
                currentAccessToken = headerToken;
                log('[refresh] saved New-Access-Token from header');
            } else if (json && json.data && json.data.accessToken) {
                currentAccessToken = json.data.accessToken;
                log('[refresh] saved accessToken from body');
            }
            if (json && json.data && (json.data.username || json.data.userAvatarUrl)) {
                setUserInfoFromPayload(json.data);
            }
        } catch(e){ log('[refresh] error: ' + e.message); }
    });

    document.getElementById('btnLogout').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/user/logout`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders())
            });
            const json = await res.json().catch(()=>null);
            log(`[logout] status=${res.status} body=${JSON.stringify(json)}`);
            currentAccessToken = null;
            setUserInfoFromPayload(null);
        } catch(e){ log('[logout] error: ' + e.message); }
    });

    document.getElementById('btnPing').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/user/ping`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders())
            });
            const json = await res.json().catch(()=>null);
            log(`[ping] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[ping] error: ' + e.message); }
    });

    // ------------------- Attachment handlers -------------------
    document.getElementById('btnPresignedGet').addEventListener('click', async () => {
        const id = document.getElementById('attachmentsIdForGet').value;
        if (!id) { alert('请输入 attachmentId'); return; }
        try {
            const res = await fetch(`${BASE}/api/attachments/${id}/presigned-get?expiry=300`, {
                method: 'GET',
                credentials: 'include',
                headers: Object.assign({}, authHeaders())
            });
            const json = await res.json().catch(()=>null);
            log(`[presigned-get] status=${res.status} body=${JSON.stringify(json)}`);
            if (json && json.url) {
                window.open(json.url, '_blank');
            }
        } catch(e){ log('[presigned-get] error: ' + e.message); }
    });

    document.getElementById('btnAttachmentsPresign').addEventListener('click', async () => {
        const f = document.getElementById('fileInput') ? document.getElementById('fileInput').files[0] : null;
        if (!f) { alert('请选择文件 (上方 file input)'); return; }
        const orig = document.getElementById('origName') ? document.getElementById('origName').value || f.name : f.name;
        const req = { storagePath: null, originalFilename: orig, contentType: f.type || 'application/octet-stream' };
        try {
            const res = await fetch(`${BASE}/api/attachments/presign`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders()),
                body: JSON.stringify(req)
            });
            const json = await res.json().catch(()=>null);
            log(`[attachments presign] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[attachments presign] error: ' + e.message); }
    });

    // ------------------- Diary handlers -------------------
    document.getElementById('btnGetMyDiaries').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/diary/getMyDiary`, {
                method: 'GET',
                credentials: 'include',
                headers: Object.assign({}, authHeaders())
            });
            const json = await res.json().catch(()=>null);
            log(`[getMyDiary] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[getMyDiary] error: ' + e.message); }
    });

    document.getElementById('btnGetDiariesByDate').addEventListener('click', async () => {
        const d = document.getElementById('dateForDiaries').value;
        if (!d) { alert('请输入日期 yyyy-mm-dd'); return; }
        try {
            const res = await fetch(`${BASE}/api/diary/date/${encodeURIComponent(d)}`, {
                method: 'GET',
                credentials: 'include',
                headers: Object.assign({}, authHeaders())
            });
            const json = await res.json().catch(()=>null);
            log(`[getDiariesByDate] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[getDiariesByDate] error: ' + e.message); }
    });

    document.getElementById('btnDeleteDiary').addEventListener('click', async () => {
        const id = document.getElementById('diaryIdToDelete').value;
        if (!id) { alert('请输入 diary id'); return; }
        try {
            const res = await fetch(`${BASE}/api/diary/delete/${id}`, {
                method: 'DELETE',
                credentials: 'include',
                headers: Object.assign({}, authHeaders())
            });
            const text = await res.text();
            log(`[deleteDiary] status=${res.status} body=${text}`);
        } catch(e){ log('[deleteDiary] error: ' + e.message); }
    });

    // ------------------- Level1 handlers -------------------
    document.getElementById('btnCreateLevel1').addEventListener('click', async () => {
        const name = document.getElementById('lvl1Name').value;
        const attach = Number(document.getElementById('lvl1AttachmentId').value || 0);
        const req = { name, attachmentId: attach, userId: null };
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/createNewFolder`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify(req)
            });
            const json = await res.json().catch(()=>null);
            log(`[createLevel1] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[createLevel1] error: ' + e.message); }
    });

    document.getElementById('btnGetUserFolders').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/getUserFolders`, {
                method: 'GET',
                credentials: 'include',
                headers: Object.assign({}, authHeaders())
            });
            const json = await res.json().catch(()=>null);
            log(`[getUserFolders] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[getUserFolders] error: ' + e.message); }
    });

    document.getElementById('btnUpdateLevel1Name').addEventListener('click', async () => {
        const id = Number(document.getElementById('lvl1Id').value || 0);
        const name = document.getElementById('lvl1NewName').value;
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/updateFolderName`, {
                method: 'PUT',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id, name })
            });
            const json = await res.json().catch(()=>null);
            log(`[updateLevel1Name] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[updateLevel1Name] error: ' + e.message); }
    });

    document.getElementById('btnUpdateLevel1Cover').addEventListener('click', async () => {
        const id = Number(document.getElementById('lvl1Id').value || 0);
        const attachment_id = Number(document.getElementById('lvl1UpdateCoverAttachment').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/updateFolderCover`, {
                method: 'PUT',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id, attachment_id })
            });
            const json = await res.json().catch(()=>null);
            log(`[updateLevel1Cover] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[updateLevel1Cover] error: ' + e.message); }
    });

    document.getElementById('btnDeleteLevel1').addEventListener('click', async () => {
        const id = Number(document.getElementById('lvl1Id').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/deleteFolder`, {
                method: 'DELETE',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id })
            });
            const json = await res.json().catch(()=>null);
            log(`[deleteLevel1] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[deleteLevel1] error: ' + e.message); }
    });

    // ------------------- Level2 handlers -------------------
    document.getElementById('btnCreateLevel2').addEventListener('click', async () => {
        const name = document.getElementById('lvl2Name').value;
        const father_id = Number(document.getElementById('lvl2ParentId').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level2/createDefaultFolder`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ father_id })
            });
            const json = await res.json().catch(()=>null);
            log(`[createLevel2] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[createLevel2] error: ' + e.message); }
    });

    document.getElementById('btnGetLevel2ByParent').addEventListener('click', async () => {
        const father_id = Number(document.getElementById('lvl2QueryParent').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level2/getFoldersByParent`, {
                method: 'GET',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ father_id })
            });
            const json = await res.json().catch(()=>null);
            log(`[getLevel2ByParent] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[getLevel2ByParent] error: ' + e.message); }
    });

    document.getElementById('btnUpdateLevel2Name').addEventListener('click', async () => {
        const id = Number(document.getElementById('lvl2Id').value || 0);
        const name = document.getElementById('lvl2NewName').value;
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level2/updateFolderName`, {
                method: 'PUT',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id, name })
            });
            const json = await res.json().catch(()=>null);
            log(`[updateLevel2Name] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[updateLevel2Name] error: ' + e.message); }
    });

    document.getElementById('btnDeleteLevel2').addEventListener('click', async () => {
        const id = Number(document.getElementById('lvl2Id').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level2/deleteFolder`, {
                method: 'DELETE',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id })
            });
            const json = await res.json().catch(()=>null);
            log(`[deleteLevel2] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[deleteLevel2] error: ' + e.message); }
    });

    // ------------------- Collected Item handlers -------------------
    document.getElementById('btnCreateItemCustom').addEventListener('click', async () => {
        const attachment_id = Number(document.getElementById('itemAttachmentId').value || 0);
        const name = document.getElementById('itemName').value;
        const description = document.getElementById('itemDescription').value;
        const father_level2_id = Number(document.getElementById('itemFatherLevel2Id').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/item/createCustom`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ attachment_id, name, description, father_level2_id })
            });
            const json = await res.json().catch(()=>null);
            log(`[createItemCustom] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[createItemCustom] error: ' + e.message); }
    });

    document.getElementById('btnCreateItemDefault').addEventListener('click', async () => {
        const description = document.getElementById('itemDescription').value;
        const father_level2_id = Number(document.getElementById('itemFatherLevel2Id').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/item/createDefault`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ description, father_level2_id })
            });
            const json = await res.json().catch(()=>null);
            log(`[createItemDefault] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[createItemDefault] error: ' + e.message); }
    });

    document.getElementById('btnUpdateItemName').addEventListener('click', async () => {
        const id = Number(document.getElementById('itemId').value || 0);
        const name = document.getElementById('itemNewName').value;
        try {
            const res = await fetch(`${BASE}/api/collection/item/update/name`, {
                method: 'PUT',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id, name })
            });
            const json = await res.json().catch(()=>null);
            log(`[updateItemName] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[updateItemName] error: ' + e.message); }
    });

    document.getElementById('btnUpdateItemDesc').addEventListener('click', async () => {
        const id = Number(document.getElementById('itemId').value || 0);
        const description = document.getElementById('itemNewDesc').value;
        try {
            const res = await fetch(`${BASE}/api/collection/item/update/description`, {
                method: 'PUT',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id, description })
            });
            const json = await res.json().catch(()=>null);
            log(`[updateItemDesc] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[updateItemDesc] error: ' + e.message); }
    });

    document.getElementById('btnUpdateItemCover').addEventListener('click', async () => {
        const id = Number(document.getElementById('itemId').value || 0);
        const attachment_id = Number(document.getElementById('itemNewCoverAttachment').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/item/update/cover`, {
                method: 'PUT',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id, attachment_id })
            });
            const json = await res.json().catch(()=>null);
            log(`[updateItemCover] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[updateItemCover] error: ' + e.message); }
    });

    document.getElementById('btnDeleteItem').addEventListener('click', async () => {
        const id = Number(document.getElementById('itemId').value || 0);
        try {
            const res = await fetch(`${BASE}/api/collection/item/delete`, {
                method: 'DELETE',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ id })
            });
            const json = await res.json().catch(()=>null);
            log(`[deleteItem] status=${res.status} body=${JSON.stringify(json)}`);
        } catch(e){ log('[deleteItem] error: ' + e.message); }
    });

    // ------------------- User avatar upload & bind reuse -------------------
    async function uploadToPresigned(putUrl, putHeaders, file, contentType) {
        const uploadHeaders = {};
        for (const k in putHeaders) {
            if (!Object.prototype.hasOwnProperty.call(putHeaders, k)) continue;
            uploadHeaders[k] = putHeaders[k];
        }
        uploadHeaders['Content-Type'] = contentType;
        const uploadRes = await fetch(putUrl, { method: 'PUT', headers: uploadHeaders, body: file });
        log(`[upload] PUT -> status=${uploadRes.status} ${uploadRes.statusText}`);
        return uploadRes.ok;
    }

    document.getElementById('btnUserPresignUpload').addEventListener('click', async () => {
        const f = document.getElementById('avatarFileInput').files[0];
        if (!f) { alert('请选择文件'); return; }
        const orig = document.getElementById('avatarOrigName').value || f.name;
        const contentType = f.type || 'application/octet-stream';
        try {
            const res = await fetch(`${BASE}/api/user/presign`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ originalFilename: orig, mimeType: contentType })
            });
            const json = await res.json().catch(()=>null);
            log(`[user presign] status=${res.status} body=${JSON.stringify(json)}`);
            if (!res.ok) return;
            const attachmentId = json.attachmentId || json.id;
            const putUrl = json.putUrl || json.url;
            const putHeaders = json.putHeaders || json.headers || {};
            const ok = await uploadToPresigned(putUrl, putHeaders, f, contentType);
            if (!ok) return;
            const completeRes = await fetch(`${BASE}/api/attachments/complete`, {
                method: 'POST', credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ attachmentId })
            });
            const completeJson = await completeRes.json().catch(()=>null);
            log(`[complete] status=${completeRes.status} body=${JSON.stringify(completeJson)}`);
            if (completeRes.ok) {
                lastAvatarAttachmentId = attachmentId;
                document.getElementById('avatarAttachmentId').textContent = String(attachmentId);
                document.getElementById('btnBindAvatar').disabled = false;
                try {
                    const getRes = await fetch(`${BASE}/api/attachments/${attachmentId}/presigned-get?expiry=300`, {
                        method: 'GET', credentials: 'include', headers: Object.assign({}, authHeaders())
                    });
                    const getJson = await getRes.json().catch(()=>null);
                    const url = getJson && (getJson.url || Object.values(getJson)[0]);
                    if (url) {
                        const img = document.getElementById('avatarPreview');
                        img.src = url; img.style.display = 'block';
                    }
                } catch(e){ log('[user presign] presigned-get failed: ' + e.message); }
            }
        } catch(e){ log('[user presign] error: '+e.message); }
    });

    document.getElementById('btnBindAvatar').addEventListener('click', async () => {
        if (!lastAvatarAttachmentId) { alert('先上传头像'); return; }
        try {
            const res = await fetch(`${BASE}/api/user/userAvatar`, {
                method: 'POST', credentials: 'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ attachmentId: lastAvatarAttachmentId })
            });
            const json = await res.json().catch(()=>null);
            log(`[bindAvatar] status=${res.status} body=${JSON.stringify(json)}`);
            if (res.ok) {
                const data = json.data || json;
                if (data && data.avatarUrl) {
                    document.getElementById('userAvatarSmall').src = data.avatarUrl;
                    document.getElementById('userAvatarSmall').style.display = 'block';
                }
            }
        } catch(e){ log('[bindAvatar] error: ' + e.message); }
    });

    // debug interval
    setInterval(()=> {
        log('[debug] accessToken=' + (currentAccessToken ? '***' + currentAccessToken.slice(-8) : 'null'));
    }, 60000);
</script>
</body>
</html>
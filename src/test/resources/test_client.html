<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anime - 模块化测试客户端（修正版：Diary 图片块解析 & Collections）</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; padding: 20px; max-width: 1200px; margin: auto; background:#f6f8fa; }
        h2,h3 { margin: 8px 0; }
        .module { border: 1px solid #e6e9ee; padding: 12px; margin: 12px 0; border-radius: 8px; background: #fff; }
        .flex { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
        input, button, textarea, select { font-size: 14px; margin: 4px 0; }
        .log { white-space: pre-wrap; background: #f7f7f7; padding: 8px; border-radius: 4px; max-height: 320px; overflow:auto; }
        .placeholder { color:#999; font-size:13px; }
        .diary-editor { min-height: 200px; border:1px dashed #ddd; padding:10px; border-radius:6px; background:#fff; overflow:auto; }
        .diary-editor:focus { outline: 2px solid #64CBFF; }
        .diary-display { border:1px solid #eee; padding:12px; border-radius:6px; background:#fff; margin-top:12px; }
        .diary-title { font-size:20px; font-weight:600; margin-bottom:8px; }
        .diary-paragraph { margin:8px 0; line-height:1.6; white-space:pre-wrap; }
        .diary-image { display:block; margin:8px 0; max-width:720px; max-height:480px; }
        .user-info-json { white-space:pre-wrap; background:#fbfbff; padding:8px; border-radius:6px; border:1px solid #eef; max-height:200px; overflow:auto; }
        .avatar-preview { max-width:160px; max-height:160px; border:1px solid #ccc; border-radius:6px; display:block; margin-top:8px; object-fit:cover; }
        .small { font-size:13px; color:#666; }
        .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    </style>
</head>
<body>
<h2>测试客户端（修正版：Diary 图片块解析 & Collections）</h2>
<p class="small">说明：图片在插入时立即 presign -> PUT -> complete 得到 attachmentId；保存日记只提交 attachmentId（BlockDTO 要求）。</p>

<!-- Auth module -->
<div id="mod-auth" class="module">
    <h3>1) Auth（登录 / refresh / whoami）</h3>
    <div class="flex">
        <label>用户名/邮箱: <input id="username" value="test_name"></label>
        <label>密码: <input id="password" type="password" value="test_password"></label>
        <button id="btnLogin">登录 (/api/user/login)</button>
        <button id="btnRefresh">刷新 access token (/api/auth/refresh)</button>
        <button id="btnWhoami">WhoAmI (/api/test/whoami)</button>
    </div>
    <div style="margin-top:10px;">
        <strong>当前用户信息（JSON）：</strong>
        <div id="userInfoJson" class="user-info-json">未登录</div>
        <div style="margin-top:8px;">
            <img id="userAvatarSmall" class="avatar-preview" src="" alt="avatar" style="display:none;">
        </div>
    </div>
</div>

<!-- Diary module -->
<div id="mod-diary" class="module">
    <h3>2) Diary（自由编辑 -> 前端解析为 blocks -> 保存）</h3>

    <div style="margin-bottom:8px;">
        <label>Diary Title: <input id="diaryTitle" style="width:60%;"></label>
        <label>Diary ID（可留空新建）: <input id="diaryId" placeholder="diary id" style="width:120px"></label>
        <label>Version（可留空）: <input id="diaryVersion" placeholder="version" style="width:120px"></label>
    </div>

    <div class="toolbar">
        <input type="file" id="diaryImageFile" accept="image/*" style="display:inline-block">
        <button id="btnInsertImageFromFile">插入图片（上传并插入预览）</button>
        <button id="btnSaveDiary">保存日记 (/api/diary/save)</button>
        <button id="btnLoadDiary">加载 Diary（按 diaryId）</button>
    </div>

    <div id="diaryEditor" class="diary-editor" contenteditable="true" placeholder="在此输入你的日记：支持文本、回车分段、粘贴或插入图片（Ctrl+V 粘贴图片）"></div>

    <div style="margin-top:10px;" class="small">提示：图片在插入时就会上传并关联 attachmentId，保存时会把这些 attachmentId 一并提交给后端。</div>

    <div class="diary-display" id="diaryDisplay">
        <div class="diary-title" id="diaryDisplayTitle">（未加载）</div>
        <div id="diaryDisplayContent">保存并加载后在此显示日记内容</div>
    </div>
</div>

<!-- Attachments helper -->
<div id="mod-attachments" class="module">
    <h3>3) Attachments（通用）</h3>
    <div class="flex">
        <input type="file" id="fileInput" accept="image/*">
        <label>原始文件名：<input id="origName" placeholder="原始文件名"></label>
        <button id="btnPresignUpload">通用 presign 并上传 (/api/attachments/presign)</button>
    </div>
    <div style="margin-top:6px;">最近上传的 attachmentId: <span id="lastAttachmentId">-</span></div>
</div>

<!-- Collections module -->
<div id="mod-collections" class="module">
    <h3>4) Collections（测试）</h3>
    <div style="margin-bottom:8px;">
        <strong>Level1 封面上传（presign）</strong>
        <div class="flex">
            <button id="btnLevel1PresignUpload">Level1 presign 并上传</button>
            <label>最近 Level1 上传的 attachmentId: <input id="level1LastAttachmentId" readonly style="width:160px"></label>
        </div>
    </div>

    <hr>

    <div>
        <strong>创建一级收藏夹</strong>
        <label>名称: <input id="level1CreateName" placeholder="收藏夹名称"></label>
        <label>封面 attachmentId: <input id="level1CreateAttachmentId" placeholder="可以使用上方最近上传的ID"></label>
        <button id="btnCreateLevel1">创建一级收藏夹 (/api/collection/folder/level1/createNewFolder)</button>
    </div>

    <hr>

    <div>
        <strong>获取当前用户的一级收藏夹</strong>
        <button id="btnGetUserLevel1">获取 (/api/collection/folder/level1/getUserFolders)</button>
        <div id="level1List" style="margin-top:8px;"></div>
    </div>

    <hr>

    <div>
        <strong>更新一级收藏夹名称 / 封面 / 删除</strong>
        <label>收藏夹ID: <input id="level1UpdateNameId" placeholder="id" style="width:160px"></label>
        <label>新名称: <input id="level1UpdateNameVal" placeholder="新名称"></label>
        <button id="btnUpdateLevel1Name">更新名称</button>

        <label>收藏夹ID: <input id="level1UpdateCoverId" placeholder="id" style="width:160px"></label>
        <label>封面 attachmentId: <input id="level1UpdateCoverAttachmentId" placeholder="attachment id"></label>
        <button id="btnUpdateLevel1Cover">更新封面</button>

        <label>收藏夹ID: <input id="level1DeleteId" placeholder="id" style="width:160px"></label>
        <button id="btnDeleteLevel1">删除</button>
    </div>
</div>

<!-- Avatar module -->
<div id="mod-avatar" class="module">
    <h3>5) User Avatar（头像专用）</h3>
    <div class="flex">
        <input type="file" id="avatarFileInput" accept="image/*">
        <label>原始文件名: <input id="avatarOrigName" placeholder="avatar.jpg"></label>
        <button id="btnUserPresignUpload">获取 presign 并上传 (/api/user/presign)</button>
        <button id="btnBindAvatar" disabled>绑定头像 (/api/user/userAvatar)</button>
    </div>
    <div style="margin-top:8px;">
        最近上传的 attachmentId: <span id="avatarAttachmentId">-</span>
        <img id="avatarPreview" class="avatar-preview" src="" alt="avatar preview" style="display:none;">
    </div>
</div>

<!-- Log -->
<div id="mod-log" class="module">
    <h3>日志 / 响应</h3>
    <div id="log" class="log"></div>
</div>

<script>
    /* 修正要点：
       - parseEditorToBlocks 使用递归按文档顺序 walk DOM，遇到 <img> 即生成 image block（包含 attachmentId）。
       - 插入图片确保以 wrapper div 包裹并添加 dataset.attachmentId 与 previewUrl。
       - 保存 payload 严格匹配 BlockDTO 字段（不包含 url）。
    */

    const BASE = 'https://localhost:8443';
    let currentAccessToken = null;
    let lastAttachmentId = null;
    let lastAvatarAttachmentId = null;

    function log(msg) {
        const el = document.getElementById('log');
        const now = new Date().toISOString();
        el.textContent = `${now}  ${msg}\n\n` + el.textContent;
    }
    function authHeaders() {
        const headers = {};
        if (currentAccessToken) headers['Authorization'] = 'Bearer ' + currentAccessToken;
        return headers;
    }

    /* ---------- Auth ---------- */
    document.getElementById('btnLogin').addEventListener('click', async () => {
        try {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const res = await fetch(`${BASE}/api/user/login`, {
                method: 'POST', credentials: 'include',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ usernameOrEmail: username, password })
            });
            const text = await res.text();
            log(`[login] status=${res.status} body=${text}`);
            const newAccess = res.headers.get('New-Access-Token');
            if (newAccess) { currentAccessToken = newAccess; log('[login] got New-Access-Token'); }
            let json = null; try { json = JSON.parse(text); } catch(e) { json = null; }
            const payload = json && json.data !== undefined ? json.data : json;
            if (payload && typeof payload === 'object') {
                if (payload.accessToken && !currentAccessToken) currentAccessToken = payload.accessToken;
                document.getElementById('userInfoJson').textContent = JSON.stringify(payload, null, 2);
                if (payload.userAvatarUrl) { const av = document.getElementById('userAvatarSmall'); av.src = payload.userAvatarUrl; av.style.display='block'; }
            } else {
                document.getElementById('userInfoJson').textContent = text || '无内容';
            }
        } catch (e) { log('[login] error: ' + e.message); }
    });
    document.getElementById('btnRefresh').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/auth/refresh`, { method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest' }});
            const json = await res.json().catch(()=>null); log(`[refresh] status=${res.status} body=${JSON.stringify(json)}`);
            const headerToken = res.headers.get('New-Access-Token');
            if (headerToken) { currentAccessToken = headerToken; log('[refresh] got New-Access-Token'); } else if (json && json.data && json.data.accessToken) { currentAccessToken = json.data.accessToken; }
        } catch (e) { log('[refresh] error: ' + e.message); }
    });
    document.getElementById('btnWhoami').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/test/whoami`, { method:'GET', headers: Object.assign({}, authHeaders()), credentials:'include' });
            const text = await res.text().catch(()=>null); log(`[whoami] status=${res.status} body=${text}`);
        } catch (e) { log('[whoami] error: ' + e.message); }
    });

    /* ---------- Generic presign + PUT upload helper ---------- */
    async function uploadToPresigned(putUrl, putHeaders, fileOrBlob, contentType) {
        const uploadHeaders = {};
        for (const k in putHeaders) if (Object.prototype.hasOwnProperty.call(putHeaders,k)) uploadHeaders[k]=putHeaders[k];
        uploadHeaders['Content-Type'] = contentType || (fileOrBlob.type || 'application/octet-stream');
        const uploadRes = await fetch(putUrl, { method:'PUT', headers: uploadHeaders, body: fileOrBlob });
        log(`[upload] PUT -> status=${uploadRes.status} ${uploadRes.statusText}`);
        if (!uploadRes.ok) { const text = await uploadRes.text().catch(()=>null); return {ok:false,text}; }
        return { ok:true };
    }

    /* ---------- Diary: insert & parse logic ---------- */
    const diaryEditor = document.getElementById('diaryEditor');

    // paste images -> presign/upload/complete -> insert
    diaryEditor.addEventListener('paste', async (e) => {
        const items = e.clipboardData && e.clipboardData.items;
        if (!items) return;
        for (const item of items) {
            if (item.type && item.type.startsWith('image/')) {
                e.preventDefault();
                const blob = item.getAsFile();
                await presignUploadAndInsertImage(blob);
            }
        }
    });

    // insert via file input
    document.getElementById('btnInsertImageFromFile').addEventListener('click', async () => {
        const finput = document.getElementById('diaryImageFile');
        const f = finput.files && finput.files[0];
        if (!f) { alert('请选择图片文件'); return; }
        await presignUploadAndInsertImage(f);
        finput.value = '';
    });

    // presign -> PUT -> complete -> insert wrapper with img (and dataset.attachmentId)
    async function presignUploadAndInsertImage(blob) {
        try {
            const contentType = blob.type || 'application/octet-stream';
            const presignReq = { originalFilename: 'pasted-image', mimeType: contentType };
            const presignRes = await fetch(`${BASE}/api/diary/presign`, { method:'POST', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify(presignReq) });
            const presignJson = await presignRes.json().catch(()=>null);
            log(`[diary presign] status=${presignRes.status} body=${JSON.stringify(presignJson)}`);
            if (!presignRes.ok) { alert('图片 presign 失败，请查看日志'); return; }
            const attachmentId = presignJson.attachmentId || presignJson.id;
            const putUrl = presignJson.putUrl || presignJson.url;
            const putHeaders = presignJson.putHeaders || presignJson.headers || {};
            if (!putUrl || !attachmentId) { alert('presign 返回不完整'); return; }

            const up = await uploadToPresigned(putUrl, putHeaders, blob, contentType);
            if (!up.ok) { alert('图片上传失败，请查看日志'); return; }

            const completeRes = await fetch(`${BASE}/api/attachments/complete`, { method:'POST', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ attachmentId }) });
            const completeJson = await completeRes.json().catch(()=>null);
            log(`[diary complete] status=${completeRes.status} body=${JSON.stringify(completeJson)}`);
            if (!completeRes.ok) { alert('图片 complete 失败'); return; }

            // create wrapper block with img
            const tempUrl = URL.createObjectURL(blob);
            const img = document.createElement('img'); img.src = tempUrl; img.alt='image'; img.style.maxWidth='60%';
            img.dataset.attachmentId = String(attachmentId); img.dataset.previewUrl = tempUrl;

            const wrapper = document.createElement('div'); wrapper.className = 'diary-image-block'; wrapper.appendChild(img);

            insertNodeAtCaret(wrapper);

            // insert an empty div after wrapper for caret usability
            const br = document.createElement('div'); br.innerHTML = '<br>';
            if (wrapper.nextSibling) wrapper.parentNode.insertBefore(br, wrapper.nextSibling);
            else wrapper.parentNode.appendChild(br);

            lastAttachmentId = attachmentId;
            document.getElementById('lastAttachmentId').innerText = String(attachmentId);
        } catch (e) {
            log('[presignUploadAndInsertImage] error: ' + e.message); alert('图片插入失败：' + e.message);
        }
    }

    function insertNodeAtCaret(node) {
        const sel = window.getSelection();
        if (!sel || !sel.rangeCount) { diaryEditor.appendChild(node); diaryEditor.appendChild(document.createElement('div')); return; }
        const range = sel.getRangeAt(0);
        range.deleteContents();
        range.insertNode(node);
        range.setStartAfter(node); range.setEndAfter(node);
        sel.removeAllRanges(); sel.addRange(range);
    }

    // parse editor to blocks using robust DOM walk
    function parseEditorToBlocks() {
        const blocks = [];
        let position = 1;
        let currentText = '';

        function flushText() {
            if (currentText && currentText.trim()) {
                blocks.push({ blockId: null, type: 'text', content: currentText.trim(), attachmentId: null, metadata: null, position: position++ });
                currentText = '';
            }
        }

        function walk(node) {
            if (!node) return;
            if (node.nodeType === Node.TEXT_NODE) {
                currentText += node.textContent || '';
                return;
            }
            if (node.nodeType !== Node.ELEMENT_NODE) return;

            const tag = node.tagName.toLowerCase();
            if (tag === 'img') {
                // image node encountered
                flushText();
                const img = node;
                const aid = img.dataset && img.dataset.attachmentId ? Number(img.dataset.attachmentId) : null;
                blocks.push({ blockId: null, type: 'image', content: null, attachmentId: aid, metadata: null, position: position++ });
                return;
            }

            // If this is a block-level element, process children then flush text as a paragraph
            const blockTags = ['div', 'p', 'section', 'article', 'li', 'blockquote', 'figure'];
            if (blockTags.includes(tag)) {
                // process children preserving order (images inside will be handled)
                const children = Array.from(node.childNodes);
                for (const c of children) walk(c);
                flushText();
                return;
            }

            // inline element or other: recurse
            const children = Array.from(node.childNodes);
            for (const c of children) walk(c);
        }

        // walk top-level children in order
        const topChildren = Array.from(diaryEditor.childNodes);
        for (const c of topChildren) walk(c);
        flushText();

        return blocks;
    }

    /* ---------- Save diary (validate and send blocks matching BlockDTO) ---------- */
    document.getElementById('btnSaveDiary').addEventListener('click', async () => {
        try {
            document.getElementById('btnSaveDiary').disabled = true;
            const title = document.getElementById('diaryTitle').value || '';
            const diaryIdVal = document.getElementById('diaryId').value || null;
            const diaryVersion = document.getElementById('diaryVersion').value || null;

            const parsed = parseEditorToBlocks();
            log(`[diary] parsed blocks count=${parsed.length}; parsed=${JSON.stringify(parsed)}`);

            // ensure each image block has attachmentId
            const missing = parsed.filter(b => b.type === 'image' && !b.attachmentId);
            if (missing.length > 0) {
                alert('检测到未上传的图片（没有 attachmentId）。请使用“插入图片（上传并插入预览）”按钮重新插入后再保存，或删除外链图片。');
                document.getElementById('btnSaveDiary').disabled = false;
                return;
            }

            // payload matching BlockDTO fields only
            const blocksPayload = parsed.map(b => ({
                blockId: b.blockId || null,
                type: b.type,
                content: b.type === 'text' ? (b.content || '') : null,
                attachmentId: b.type === 'image' ? (b.attachmentId || null) : null,
                metadata: null,
                position: b.position // 1-based as BlockService expects
            }));

            const diary = {};
            if (diaryIdVal) diary.id = Number(diaryIdVal);
            if (diaryVersion) diary.version = Number(diaryVersion);
            diary.title = title;

            // send save request
            const res = await fetch(`${BASE}/api/diary/save`, {
                method:'POST', credentials:'include',
                headers: Object.assign({'Content-Type':'application/json'}, authHeaders()),
                body: JSON.stringify({ diary, blocks: blocksPayload })
            });
            const data = await res.json().catch(()=>null);
            log(`[saveDiary] status=${res.status} body=${JSON.stringify(data)}`);
            if (!res.ok) { alert('保存失败，请查看日志'); document.getElementById('btnSaveDiary').disabled = false; return; }

            const result = data && data.data ? data.data : data;
            if (result && result.diary) {
                document.getElementById('diaryId').value = result.diary.id || '';
                document.getElementById('diaryVersion').value = result.diary.version || '';
            }

            // re-render editor from returned blocks (backend usually injects attachmentUrl for image blocks)
            if (result && result.blocks && Array.isArray(result.blocks)) {
                await renderEditorFromBlocks(result.blocks);
            } else {
                await renderDiaryFromEditor();
            }
            alert('保存成功');
        } catch (e) {
            log('[saveDiary] error: ' + e.message); alert('保存失败：' + e.message);
        } finally { document.getElementById('btnSaveDiary').disabled = false; }
    });

    /* ---------- Render helpers ---------- */
    async function renderEditorFromBlocks(blocks) {
        diaryEditor.innerHTML = '';
        for (const b of blocks) {
            if (b.type === 'text') {
                const p = document.createElement('div'); p.className='diary-paragraph'; p.textContent = b.content || ''; diaryEditor.appendChild(p);
            } else if (b.type === 'image') {
                const wrapper = document.createElement('div'); wrapper.className='diary-image-block';
                const img = document.createElement('img'); img.className='diary-image';
                if (b.attachmentUrl) { img.src = b.attachmentUrl; if (b.attachmentId) img.dataset.attachmentId = String(b.attachmentId); }
                else if (b.attachmentId) {
                    try {
                        const getRes = await fetch(`${BASE}/api/attachments/${b.attachmentId}/presigned-get?expiry=300`, { method:'GET', credentials:'include', headers:Object.assign({}, authHeaders()) });
                        const j = await getRes.json().catch(()=>null);
                        const url = j && (j.url || j.data) ? (j.url || j.data) : null;
                        if (url) img.src = url;
                        img.dataset.attachmentId = String(b.attachmentId);
                    } catch(e) { img.src = ''; }
                } else if (b.url) { img.src = b.url; }
                wrapper.appendChild(img); diaryEditor.appendChild(wrapper);
            }
        }
        await renderDiaryFromEditor();
    }

    async function renderDiaryFromEditor() {
        const title = document.getElementById('diaryTitle').value || '(未命名)';
        document.getElementById('diaryDisplayTitle').textContent = title;
        const contentEl = document.getElementById('diaryDisplayContent'); contentEl.innerHTML = '';
        const children = Array.from(diaryEditor.childNodes);
        for (const node of children) {
            if (node.nodeType === Node.TEXT_NODE) {
                const text = node.textContent && node.textContent.trim();
                if (text) { const p=document.createElement('div'); p.className='diary-paragraph'; p.textContent=text; contentEl.appendChild(p); }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                const el = node; const tag = el.tagName.toLowerCase();
                if (tag === 'div' && el.querySelector('img')) {
                    const imgEl = el.querySelector('img');
                    const img = document.createElement('img'); img.className='diary-image';
                    if (imgEl.dataset && imgEl.dataset.previewUrl) img.src = imgEl.dataset.previewUrl;
                    else if (imgEl.src) img.src = imgEl.src;
                    contentEl.appendChild(img);
                } else {
                    const text = el.innerText || el.textContent || '';
                    if (text && text.trim()) { const p=document.createElement('div'); p.className='diary-paragraph'; p.textContent=text.trim(); contentEl.appendChild(p); }
                }
            }
        }
    }

    /* ---------- Load diary ---------- */
    document.getElementById('btnLoadDiary').addEventListener('click', async () => {
        const id = document.getElementById('diaryId').value; if (!id) { alert('请输入 diaryId'); return; }
        try {
            const res = await fetch(`${BASE}/api/diary/id/${id}`, { method:'GET', credentials:'include', headers: Object.assign({}, authHeaders()) });
            const data = await res.json().catch(()=>null); log(`[getDiary] status=${res.status} body=${JSON.stringify(data)}`);
            if (!res.ok) { alert('加载失败，请查看日志'); return; }
            const result = data.data ? data.data : data;
            if (result && result.diary) { document.getElementById('diaryTitle').value = result.diary.title || ''; document.getElementById('diaryVersion').value = result.diary.version || ''; document.getElementById('diaryId').value = result.diary.id || id; }
            const blocks = result.blocks || []; await renderEditorFromBlocks(blocks);
        } catch (e) { log('[getDiary] error: ' + e.message); }
    });

    /* ---------- Collections (kept as earlier) ---------- */
    document.getElementById('btnLevel1PresignUpload').addEventListener('click', async () => {
        const f = document.getElementById('fileInput').files[0]; if (!f) { alert('请选择文件'); return; }
        const orig = document.getElementById('origName').value || f.name; const contentType = f.type || 'application/octet-stream';
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/presign`, { method:'POST', credentials:'include', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ originalFilename: orig, mimeType: contentType }) });
            const resp = await res.json().catch(()=>null); log(`[level1 presign] status=${res.status} body=${JSON.stringify(resp)}`);
            if (!res.ok) return;
            const attachmentId = resp.attachmentId || resp.id; const putUrl = resp.putUrl || resp.url; const putHeaders = resp.putHeaders || resp.headers || {};
            const ok = await uploadToPresigned(putUrl, putHeaders, f, contentType); if (!ok.ok) return;
            const completeRes = await fetch(`${BASE}/api/attachments/complete`, { method:'POST', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ attachmentId }) });
            const completeBody = await completeRes.json().catch(()=>null); log(`[level1 complete] status=${completeRes.status} body=${JSON.stringify(completeBody)}`);
            if (completeRes.ok) { document.getElementById('level1LastAttachmentId').value = attachmentId; document.getElementById('level1CreateAttachmentId').value = attachmentId; }
        } catch (e) { log('[level1 presign/upload] error: ' + e.message); }
    });
    document.getElementById('btnCreateLevel1').addEventListener('click', async () => {
        const name = document.getElementById('level1CreateName').value; const attachmentId = Number(document.getElementById('level1CreateAttachmentId').value) || null;
        if (!name || !attachmentId) { alert('请填写 name 与 attachmentId'); return; }
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/createNewFolder`, { method:'POST', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ name, attachmentId }) });
            const body = await res.json().catch(()=>null); log(`[create level1] status=${res.status} body=${JSON.stringify(body)}`);
        } catch (e) { log('[create level1] error: ' + e.message); }
    });
    document.getElementById('btnGetUserLevel1').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/getUserFolders`, { method:'POST', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()) });
            const body = await res.json().catch(()=>null); log(`[get user level1] status=${res.status} body=${JSON.stringify(body)}`);
            const payload = body && body.data ? body.data : body; const container = document.getElementById('level1List'); container.innerHTML=''; if (!payload || payload.length===0) { container.textContent='无一级收藏夹'; return; }
            const ul=document.createElement('ul'); for (const f of payload) { const li=document.createElement('li'); li.textContent=`id=${f.id} name=${f.name} attachmentId=${f.attachmentId || f.coverAttachmentId || ''}`; ul.appendChild(li); } container.appendChild(ul);
        } catch (e) { log('[get user level1] error: ' + e.message); }
    });
    document.getElementById('btnUpdateLevel1Name').addEventListener('click', async () => {
        const id = Number(document.getElementById('level1UpdateNameId').value); const name = document.getElementById('level1UpdateNameVal').value;
        if (!id || !name) { alert('请填写 id & name'); return; }
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/updateFolderName`, { method:'PUT', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ id, name }) });
            const body = await res.json().catch(()=>null); log(`[update level1 name] status=${res.status} body=${JSON.stringify(body)}`);
        } catch (e) { log('[update level1 name] error: ' + e.message); }
    });
    document.getElementById('btnUpdateLevel1Cover').addEventListener('click', async () => {
        const id = Number(document.getElementById('level1UpdateCoverId').value); const attachment_id = Number(document.getElementById('level1UpdateCoverAttachmentId').value);
        if (!id || !attachment_id) { alert('请填写 id & attachment id'); return; }
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/updateFolderCover`, { method:'PUT', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ id, attachment_id }) });
            const body = await res.json().catch(()=>null); log(`[update level1 cover] status=${res.status} body=${JSON.stringify(body)}`);
        } catch (e) { log('[update level1 cover] error: ' + e.message); }
    });
    document.getElementById('btnDeleteLevel1').addEventListener('click', async () => {
        const id = Number(document.getElementById('level1DeleteId').value); if (!id) { alert('请填写 id'); return; }
        try {
            const res = await fetch(`${BASE}/api/collection/folder/level1/deleteFolder`, { method:'DELETE', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ id }) });
            const body = await res.json().catch(()=>null); log(`[delete level1] status=${res.status} body=${JSON.stringify(body)}`);
        } catch (e) { log('[delete level1] error: ' + e.message); }
    });

    /* ---------- Attachments quick presign/upload ---------- */
    document.getElementById('btnPresignUpload').addEventListener('click', async () => {
        const f = document.getElementById('fileInput').files[0]; if (!f) { alert('请选择文件'); return; }
        const orig = document.getElementById('origName').value || f.name; const contentType = f.type || 'application/octet-stream';
        try {
            const res = await fetch(`${BASE}/api/attachments/presign`, { method:'POST', credentials:'include', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ storagePath:null, originalFilename: orig, contentType, uploadedBy:null, width:null, height:null }) });
            const resp = await res.json().catch(()=>null); log(`[presign] status=${res.status} body=${JSON.stringify(resp)}`);
            if (!res.ok) return;
            const attachmentId = resp.attachmentId || resp.id; const putUrl = resp.putUrl || resp.url; const putHeaders = resp.putHeaders || resp.headers || {};
            const r = await uploadToPresigned(putUrl, putHeaders, f, contentType); if (!r.ok) return;
            const completeRes = await fetch(`${BASE}/api/attachments/complete`, { method:'POST', credentials:'include', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ attachmentId }) });
            const completeBody = await completeRes.json().catch(()=>null); log(`[complete] status=${completeRes.status} body=${JSON.stringify(completeBody)}`);
            if (completeRes.ok) { lastAttachmentId = attachmentId; document.getElementById('lastAttachmentId').innerText = String(attachmentId); }
        } catch (e) { log('[presign/upload] error: ' + e.message); }
    });

    /* ---------- Avatar presign/upload & bind ---------- */
    document.getElementById('btnUserPresignUpload').addEventListener('click', async () => {
        const f = document.getElementById('avatarFileInput').files[0]; if (!f) { alert('请选择头像文件'); return; }
        const orig = document.getElementById('avatarOrigName').value || f.name; const contentType = f.type || 'application/octet-stream';
        try {
            const res = await fetch(`${BASE}/api/user/presign`, { method:'POST', credentials:'include', headers:Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ originalFilename: orig, mimeType: contentType }) });
            const resp = await res.json().catch(()=>null); log(`[user presign] status=${res.status} body=${JSON.stringify(resp)}`); if (!res.ok) return;
            const attachmentId = resp.attachmentId || resp.id; const putUrl = resp.putUrl || resp.url; const putHeaders = resp.putHeaders || resp.headers || {};
            if (!putUrl || !attachmentId) { log('[user presign] invalid response'); return; }
            const ok = await uploadToPresigned(putUrl, putHeaders, f, contentType); if (!ok.ok) { log('[user presign] upload failed'); return; }
            const completeRes = await fetch(`${BASE}/api/attachments/complete`, { method:'POST', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ attachmentId }) });
            const completeBody = await completeRes.json().catch(()=>null); log(`[user complete] status=${completeRes.status} body=${JSON.stringify(completeBody)}`);
            if (completeRes.ok) { lastAvatarAttachmentId = attachmentId; document.getElementById('avatarAttachmentId').innerText = String(attachmentId); document.getElementById('btnBindAvatar').disabled = false; const pv = document.getElementById('avatarPreview'); pv.src = URL.createObjectURL(f); pv.style.display='block'; }
        } catch (e) { log('[user presign/upload] error: ' + e.message); }
    });
    document.getElementById('btnBindAvatar').addEventListener('click', async () => {
        if (!lastAvatarAttachmentId) { alert('请先上传头像'); return; }
        try {
            const res = await fetch(`${BASE}/api/user/userAvatar`, { method:'POST', credentials:'include', headers: Object.assign({'Content-Type':'application/json'}, authHeaders()), body: JSON.stringify({ attachmentId: lastAvatarAttachmentId }) });
            const body = await res.json().catch(()=>null); log(`[bindAvatar] status=${res.status} body=${JSON.stringify(body)}`);
            if (res.ok) { alert('绑定头像成功'); const payload = body && body.data ? body.data : body; if (payload && payload.avatarUrl) { const pv = document.getElementById('avatarPreview'); pv.src = payload.avatarUrl; pv.style.display='block'; } }
            else { alert('绑定头像失败: ' + JSON.stringify(body)); }
        } catch (e) { log('[bindAvatar] error: ' + e.message); }
    });

    diaryEditor.addEventListener('input', () => {
        if (window._renderTimeout) clearTimeout(window._renderTimeout);
        window._renderTimeout = setTimeout(() => { renderDiaryFromEditor().catch(()=>{}); }, 200);
    });
    renderDiaryFromEditor().catch(()=>{});
</script>
</body>
</html>
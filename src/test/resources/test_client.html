<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Anime - 测试客户端 (login / presign / upload / diary)</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
        input, button, textarea { font-size: 14px; margin: 4px 0; }
        .box { border: 1px solid #ddd; padding: 12px; margin: 12px 0; border-radius: 6px; }
        .log { white-space: pre-wrap; background: #f7f7f7; padding: 8px; border-radius: 4px; max-height: 240px; overflow:auto; }
        label { display:block; margin-top:8px; }
        .diary-header { margin: 8px 0; padding: 8px; border-bottom: 1px solid #eee; }
        .blocks { margin-top: 12px; }
        .block { border: 1px solid #eee; padding: 8px; margin: 8px 0; border-radius: 6px; display:flex; gap:12px; align-items:flex-start; }
        .block img { max-width: 320px; max-height: 240px; object-fit:contain; border-radius:4px; }
        .block .meta { flex:1; }
        .placeholder { color:#999; font-size:13px; }
    </style>
</head>
<body>
<h2>测试客户端：登录 / presign / upload / diary（含显示 blocks）</h2>

<div class="box">
    <h3>1) 登录（会写 refreshToken cookie，返回 access token 到 header）</h3>
    <label>用户名或邮箱：<input id="username" value="test_name"></label>
    <label>密码：<input id="password" type="password" value="test_password"></label>
    <button id="btnLogin">登录 (POST /api/user/login)</button>
    <p>说明：登录后会把 access token 存到内存 (accessToken)，refresh token 写入 HttpOnly cookie。</p>
</div>

<div class="box">
    <h3>2) 刷新 access token（使用 refresh cookie）</h3>
    <button id="btnRefresh">刷新 (POST /api/auth/refresh)</button>
    <p>说明：请求会带 cookie（需 credentials: 'include'），服务器从 refreshToken cookie 读取并返回新的 access token。</p>
</div>

<div class="box">
    <h3>2.1) WhoAmI - 验证当前 token 是否生效</h3>
    <button id="btnWhoami">WhoAmI</button>
</div>

<div class="box">
    <h3>3) 选择图片（共用 file input）</h3>
    <input type="file" id="fileInput" accept="image/*">
    <label>原始文件名（可选）：<input id="origName" placeholder="保留原文件名用于 metadata"></label>
</div>

<div class="box">
    <h3>4) /api/attachments/presign - 获取 presign 并上传</h3>
    <button id="btnPresignUpload">获取 presign 并上传 (/api/attachments/presign)</button>
</div>

<div class="box">
    <h3>4.1) /api/diary/presign - Diary 专用 presign 并上传</h3>
    <label>可选原始文件名（默认使用选中文件名）：<input id="diaryOrigName" placeholder="原始文件名"></label>
    <button id="btnDiaryPresignUpload">获取 presign 并上传 (/api/diary/presign)</button>
</div>

<div class="box">
    <h3>5) 保存日记（POST /api/diary/save）</h3>
    <label>Diary Title: <input id="diaryTitle" value="测试日记"></label>
    <label>Diary ID (更新时填写): <input id="diaryId" placeholder="留空表示新建"></label>
    <label>Diary Version (更新时填写): <input id="diaryVersion" placeholder="更新用"></label>

    <h4>Blocks JSON (示例)</h4>
    <textarea id="blocksJson" rows="6" style="width:100%;">[
  {"blockId": null, "type":"text","content":"这是一个测试文本块","attachmentId":null,"metadata":null},
  {"blockId": null, "type":"image","content":null,"attachmentId":null,"metadata":null}
]</textarea>
    <button id="btnSaveDiary">保存日记 (POST /api/diary/save)</button>
</div>

<div class="box">
    <h3>6) 获取日记（GET /api/diary/id/{id}）并在页面显示（包含图片）</h3>
    <label>Diary ID: <input id="qryDiaryId"></label>
    <button id="btnGetDiary">获取并显示日记</button>

    <div id="diaryDisplay" style="margin-top:12px;">
        <div id="diaryInfo" class="diary-header"></div>
        <div id="blocksContainer" class="blocks"></div>
    </div>
</div>

<div class="box">
    <h3>日志 / 响应</h3>
    <div id="log" class="log"></div>
</div>

<script>
    let currentAccessToken = null;
    const BASE = 'https://localhost:8443';

    function log(msg) {
        const el = document.getElementById('log');
        const now = new Date().toISOString();
        el.textContent = `${now}  ${msg}\n\n` + el.textContent;
    }

    function authHeaders() {
        const headers = {};
        if (currentAccessToken) headers['Authorization'] = 'Bearer ' + currentAccessToken;
        return headers;
    }

    // Login
    document.getElementById('btnLogin').addEventListener('click', async () => {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        try {
            const res = await fetch(`${BASE}/api/user/login`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usernameOrEmail: username, password })
            });
            const text = await res.text();
            log(`[login] status=${res.status} body=${text}`);
            const newAccess = res.headers.get('New-Access-Token');
            if (newAccess) {
                currentAccessToken = newAccess;
                log('[login] got New-Access-Token header -> saved to memory');
            } else {
                try {
                    const json = JSON.parse(text);
                    const bodyToken = json?.data?.accessToken || json?.accessToken;
                    if (bodyToken) {
                        currentAccessToken = bodyToken;
                        log('[login] got accessToken from body -> saved to memory');
                    }
                } catch (e) {}
            }
        } catch (e) {
            log('[login] error: ' + e.message);
        }
    });

    // Refresh
    document.getElementById('btnRefresh').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/auth/refresh`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
            });
            const json = await res.json().catch(()=>null);
            log(`[refresh] status=${res.status} body=${JSON.stringify(json)}`);
            const headerToken = res.headers.get('New-Access-Token');
            if (headerToken) {
                currentAccessToken = headerToken;
                log('[refresh] got New-Access-Token -> saved to memory');
            } else if (json && json.data && json.data.accessToken) {
                currentAccessToken = json.data.accessToken;
                log('[refresh] got accessToken in body -> saved to memory');
            }
        } catch (e) {
            log('[refresh] error: ' + e.message);
        }
    });

    // WhoAmI
    document.getElementById('btnWhoami').addEventListener('click', async () => {
        try {
            const res = await fetch(`${BASE}/api/test/whoami`, {
                method: 'GET',
                headers: Object.assign({}, authHeaders()),
                credentials: 'include'
            });
            const text = await res.text().catch(()=>null);
            log(`[whoami] status=${res.status} body=${text}`);
        } catch (e) {
            log('[whoami] error: ' + e.message);
        }
    });

    // upload helper
    async function uploadToPresigned(putUrl, putHeaders, file, contentType) {
        const uploadHeaders = {};
        for (const k in putHeaders) {
            if (!Object.prototype.hasOwnProperty.call(putHeaders, k)) continue;
            uploadHeaders[k] = putHeaders[k];
        }
        uploadHeaders['Content-Type'] = contentType;

        const uploadRes = await fetch(putUrl, {
            method: 'PUT',
            headers: uploadHeaders,
            body: file,
        });

        log(`[upload] PUT -> status=${uploadRes.status} ${uploadRes.statusText}`);
        if (!uploadRes.ok) {
            const text = await uploadRes.text().catch(()=>null);
            log('[upload] upload failed; response text: ' + text);
            return false;
        }
        return true;
    }

    // /api/attachments/presign
    document.getElementById('btnPresignUpload').addEventListener('click', async () => {
        const f = document.getElementById('fileInput').files[0];
        if (!f) { alert('请选择文件'); return; }
        const orig = document.getElementById('origName').value || f.name;
        const contentType = f.type || 'application/octet-stream';
        const presignReq = { storagePath: null, originalFilename: orig, contentType: contentType, uploadedBy: null, width: null, height: null };
        try {
            const res = await fetch(`${BASE}/api/attachments/presign`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders()),
                body: JSON.stringify(presignReq)
            });
            const resp = await res.json().catch(()=>null);
            log(`[presign] status=${res.status} body=${JSON.stringify(resp)}`);
            if (!res.ok) return;
            const attachmentId = resp.attachmentId || resp.id;
            const putUrl = resp.putUrl || resp.url;
            const putHeaders = resp.putHeaders || resp.headers || {};
            const ok = await uploadToPresigned(putUrl, putHeaders, f, contentType);
            if (!ok) return;
            log(`[presign] upload successful. attachmentId=${attachmentId}`);
            // finalize
            const completeRes = await fetch(`${BASE}/api/attachments/complete`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders()),
                body: JSON.stringify({ attachmentId })
            });
            const completeBody = await completeRes.json().catch(()=>null);
            log(`[complete] status=${completeRes.status} body=${JSON.stringify(completeBody)}`);
            if (completeRes.ok) {
                // autofill first empty attachmentId in blocksJson
                const blocksEl = document.getElementById('blocksJson');
                try {
                    const arr = JSON.parse(blocksEl.value);
                    for (let i = 0; i < arr.length; i++) {
                        if (arr[i].attachmentId == null) {
                            arr[i].attachmentId = attachmentId;
                            break;
                        }
                    }
                    blocksEl.value = JSON.stringify(arr, null, 2);
                } catch(e){}
            }
        } catch (e) {
            log('[presign/upload] error: ' + e.message);
        }
    });

    // /api/diary/presign
    document.getElementById('btnDiaryPresignUpload').addEventListener('click', async () => {
        const f = document.getElementById('fileInput').files[0];
        if (!f) { alert('请选择文件'); return; }
        const orig = document.getElementById('diaryOrigName').value || f.name;
        const contentType = f.type || 'application/octet-stream';
        const presignReq = { originalFilename: orig, mimeType: contentType };
        try {
            const res = await fetch(`${BASE}/api/diary/presign`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders()),
                body: JSON.stringify(presignReq)
            });
            const resp = await res.json().catch(()=>null);
            log(`[diary presign] status=${res.status} body=${JSON.stringify(resp)}`);
            if (!res.ok) return;
            const attachmentId = resp.attachmentId || resp.id;
            const putUrl = resp.putUrl || resp.url;
            const putHeaders = resp.putHeaders || resp.headers || {};
            const ok = await uploadToPresigned(putUrl, putHeaders, f, contentType);
            if (!ok) return;
            log(`[diary presign] upload successful. attachmentId=${attachmentId}`);
            // finalize via attachments/complete
            const completeRes = await fetch(`${BASE}/api/attachments/complete`, {
                method: 'POST',
                credentials: 'include',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders()),
                body: JSON.stringify({ attachmentId })
            });
            const completeBody = await completeRes.json().catch(()=>null);
            log(`[diary complete] status=${completeRes.status} body=${JSON.stringify(completeBody)}`);
            if (completeRes.ok) {
                const blocksEl = document.getElementById('blocksJson');
                try {
                    const arr = JSON.parse(blocksEl.value);
                    for (let i = 0; i < arr.length; i++) {
                        if (arr[i].attachmentId == null) {
                            arr[i].attachmentId = attachmentId;
                            break;
                        }
                    }
                    blocksEl.value = JSON.stringify(arr, null, 2);
                } catch(e){}
            }
        } catch (e) {
            log('[diary presign/upload] error: ' + e.message);
        }
    });

    // Save diary (/api/diary/save)
    document.getElementById('btnSaveDiary').addEventListener('click', async () => {
        const title = document.getElementById('diaryTitle').value;
        const diaryId = document.getElementById('diaryId').value || null;
        const diaryVersion = document.getElementById('diaryVersion').value || null;
        let blocks;
        try { blocks = JSON.parse(document.getElementById('blocksJson').value); } catch(e){ alert('blocksJson 非法'); return; }
        const diary = {};
        if (diaryId) diary.id = Number(diaryId);
        if (diaryVersion) diary.version = Number(diaryVersion);
        diary.title = title;
        const payload = { diary, blocks };
        try {
            const res = await fetch(`${BASE}/api/diary/save`, {
                method: 'POST',
                headers: Object.assign({'Content-Type': 'application/json'}, authHeaders()),
                credentials: 'include',
                body: JSON.stringify(payload)
            });
            const data = await res.json().catch(()=>null);
            log(`[saveDiary] status=${res.status} body=${JSON.stringify(data)}`);
            if (res.ok) {
                // optionally update diaryId/version and blocksJson
                const result = data && data.data ? data.data : data;
                if (result && result.diary) {
                    document.getElementById('diaryId').value = result.diary.id || '';
                    document.getElementById('diaryVersion').value = result.diary.version || '';
                }
                if (result && result.blocks) {
                    document.getElementById('blocksJson').value = JSON.stringify(result.blocks, null, 2);
                }
            } else if (res.status === 409) alert('版本冲突');
        } catch (e) { log('[saveDiary] error: ' + e.message); }
    });

    // Render diary & blocks into page
    function renderDiary(result) {
        const infoEl = document.getElementById('diaryInfo');
        const blocksContainer = document.getElementById('blocksContainer');
        infoEl.innerHTML = '';
        blocksContainer.innerHTML = '';

        if (!result || !result.diary) {
            infoEl.textContent = '未查到日记';
            return;
        }

        const d = result.diary;
        infoEl.innerHTML = `<strong>Diary #${d.id}</strong> &nbsp; <span class="placeholder">title:</span> ${escapeHtml(d.title || '')}
            <div class="placeholder">createdAt: ${d.createdAt || ''} &nbsp; updatedAt: ${d.updatedAt || ''} &nbsp; version: ${d.version || ''}</div>`;

        const blocks = result.blocks || [];
        if (blocks.length === 0) {
            blocksContainer.innerHTML = '<div class="placeholder">没有 blocks</div>';
            return;
        }

        for (const b of blocks) {
            const blockEl = document.createElement('div');
            blockEl.className = 'block';
            const imgWrapper = document.createElement('div');
            const metaDiv = document.createElement('div');
            metaDiv.className = 'meta';

            // Image case
            if (b.type && b.type.toLowerCase() === 'image' && b.attachmentUrl) {
                const img = document.createElement('img');
                img.src = b.attachmentUrl;
                img.alt = b.metadata || ('image-' + (b.id || ''));
                img.onerror = () => { img.style.opacity = 0.6; img.title = '图片加载失败'; };
                imgWrapper.appendChild(img);
            } else if (b.type && b.type.toLowerCase() === 'image') {
                // no URL available
                imgWrapper.innerHTML = '<div class="placeholder">（图片，无可用 url）</div>';
            } else {
                imgWrapper.innerHTML = '<div class="placeholder">非图片</div>';
            }

            // meta: show type, content, attachmentId, position, metadata
            const contentHtml = b.content ? `<div><strong>内容:</strong> ${escapeHtml(b.content)}</div>` : '';
            const attachmentHtml = b.attachmentId ? `<div><strong>attachmentId:</strong> ${b.attachmentId}</div>` : '';
            const posHtml = b.position != null ? `<div><strong>position:</strong> ${b.position}</div>` : '';
            const metaJson = b.metadata ? `<div><strong>metadata:</strong> ${escapeHtml(b.metadata)}</div>` : '';
            metaDiv.innerHTML = `<div><strong>类型:</strong> ${escapeHtml(b.type || '')}</div>` +
                contentHtml + attachmentHtml + posHtml + metaJson;

            blockEl.appendChild(imgWrapper);
            blockEl.appendChild(metaDiv);
            blocksContainer.appendChild(blockEl);
        }
    }

    function escapeHtml(s) {
        if (!s && s !== 0) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // Get diary and render (calls /api/diary/id/{id})
    document.getElementById('btnGetDiary').addEventListener('click', async () => {
        const id = document.getElementById('qryDiaryId').value;
        if (!id) { alert('请输入 diary id'); return; }
        try {
            const res = await fetch(`${BASE}/api/diary/id/${id}`, {
                method: 'GET',
                headers: Object.assign({}, authHeaders()),
                credentials: 'include'
            });
            const data = await res.json().catch(()=>null);
            log(`[getDiary] status=${res.status} body=${JSON.stringify(data)}`);
            if (res.status === 200 && data) {
                const result = data.data ? data.data : data;
                renderDiary(result);
            } else {
                // show error message
                document.getElementById('diaryInfo').textContent = `请求失败：status=${res.status}`;
                document.getElementById('blocksContainer').innerHTML = '';
            }
        } catch (e) {
            log('[getDiary] error: ' + e.message);
        }
    });

    // show current access token debug
    setInterval(() => {
        log('[debug] currentAccessToken=' + (currentAccessToken ? ('***' + currentAccessToken.slice(-8)) : 'null'));
    }, 60000);
</script>
</body>
</html>